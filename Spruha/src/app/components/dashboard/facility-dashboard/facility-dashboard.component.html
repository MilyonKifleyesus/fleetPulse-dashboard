<app-page-header
  [title]="'Welcome To Facility Management Dashboard'"
  [title1]="['Dashboard']"
  [activeitem]="'Facility Management'"
></app-page-header>

<!-- Summary Cards -->
<div class="row row-sm">
  @for (card of cards(); track card.title) {
  <div class="col-sm-12 col-md-6 col-lg-6 col-xl-4">
    <spk-dashboard [card]="card"></spk-dashboard>
  </div>
  }
</div>
<!-- End row -->

<!-- row opened -->
<!-- Facility Carousel -->
<div class="col-lg-12 col-md-12">
  <swiper-container
    #swiperContainer
    class="swiper mySwiper"
    space-between="10"
    slides-per-view="5"
    slides-per-group="1"
    autoplay-delay="2000"
    autoplay-disable-on-interaction="false"
  >
    @for (item of carouselItems(); track item.id) {
    <swiper-slide>
      <div class="swiper-slide">
        <div class="card custom-card">
          <div class="card-body">
            <div
              class="d-flex no-block align-items-center justify-content-between"
            >
              <div>
                <span class="text-muted fs-13 mb-3">{{ item.name }}</span>
                <h3 class="m-0 mt-2">{{ item.utilization }}%</h3>
              </div>
              <div class="mt-auto">
                <i class="fe fe-building fs-24 text-primary"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </swiper-slide>
    }
  </swiper-container>
</div>
<!--/ row closed -->

<!-- row opened -->
<div class="row row-sm">
  <div class="col-md-12 col-sm-12 col-lg-12 col-xl-12 col-xxl-4">
    <div class="card custom-card wallet-1">
      <div class="card-header border-bottom-0">
        <label class="main-content-label my-auto pt-2 mb-1"
          >Resource Allocation</label
        >
        <span class="d-block fs-12 mb-0 mt-1 text-muted"
          >Resource allocation shows the distribution of facilities across
          different categories and operational statuses</span
        >
      </div>
      <div class="card-body crypto-wallet">
        <div class="">
          <div id="crypto-donut">
            <spk-apex-charts
              [chartOptions]="resourceAllocationChart"
            ></spk-apex-charts>
          </div>
        </div>
        <div class="chart-circle-value circle-style">
          <div class="fs-20 fw-semibold">
            {{ averageUtilization().toFixed(0) }}%
          </div>
        </div>
      </div>

      <div class="table-responsive border-0 br-10 pb-3">
        <spk-reusable-tables
          [tableClass]="'border-0 mg-b-0 text-nowrap text-md-nowrap'"
        >
          @for (facility of facilities().slice(0, 3); track facility.id) {
          <tr>
            <td class="d-flex">
              <div class="cryp-icon bg-primary my-auto me-2">
                <i class="fe fe-building"></i>
              </div>
              <div class="media-body ms-3">
                <p class="mb-1 text-muted fw-normal fs-15">
                  {{ facility.name }}
                </p>
                <span class="fs-15 fw-medium my-auto"
                  >{{ facility.capacity.spaceUtilization }}%</span
                >
              </div>
            </td>
            <td>{{ facility.capacity.totalArea.toLocaleString() }} sq ft</td>
            <td>
              {{ facility.capacity.spaceUtilization >= 85 ? "+" : "-" }}
              {{
                Math.abs(facility.capacity.spaceUtilization - 85).toFixed(1)
              }}%
              <i
                [ngClass]="
                  facility.capacity.spaceUtilization >= 85
                    ? 'fa fa-arrow-up text-success ms-1'
                    : 'fa fa-arrow-down text-danger ms-1'
                "
              ></i>
            </td>
          </tr>
          }
        </spk-reusable-tables>
      </div>
    </div>
  </div>
  <div class="col-xl-12 col-xxl-8 col-lg-12 col-md-12">
    <div class="card card-bitcoin custom-card">
      <div class="card-header border-bottom-0 pb-0">
        <div>
          <label class="main-content-label my-auto pt-2 fs-15-f"
            >Facility Performance</label
          >
          <span class="d-block fs-12 mb-0 mt-1 text-muted"
            >Facility performance metrics track utilization rates, operational
            efficiency, and capacity utilization over time for optimal resource
            management.</span
          >
        </div>
      </div>
      <div class="card-body pt-0">
        <div id="btc-chart">
          <spk-apex-charts [chartOptions]="performanceChart"></spk-apex-charts>
        </div>
      </div>
      <div class="media d-sm-flex d-block px-4 pb-3 pt-1">
        <div class="media-icon bg-primary crypto-icon me-2">
          <i class="fe fe-bar-chart-2 fs-20"></i>
        </div>
        <div class="media-body ms-2">
          <div class="row row-sm">
            <div class="col">
              <label>Average Utilization</label>
              <p>{{ averageUtilization().toFixed(1) }}%</p>
            </div>
            <div class="col-6 col-sm-3">
              <label>Total Facilities</label>
              <p>{{ totalFacilities() }}</p>
            </div>
            <div class="col">
              <label>Operational</label>
              <p>{{ operationalFacilitiesCount() }}</p>
            </div>
            <div class="col">
              <label>Critical Issues</label>
              <p>{{ criticalIssuesCount() }}</p>
            </div>
            <div class="col">
              <label>Avg Capacity</label>
              <p>{{ averageUtilization().toFixed(1) }}%</p>
            </div>
          </div>
          <!-- row -->
        </div>
      </div>
    </div>
  </div>
</div>
<!-- row closed -->

<!-- row opened -->
<div class="row row-sm">
  <div class="col-md-12 col-sm-12 col-lg-12 col-xl-12 col-xxl-8">
    <div class="row row-sm">
      <div class="col-sm-12 col-md-6 col-lg-6 col-xl-6">
        <div class="card custom-card">
          <div class="card-body row">
            <div class="col-sm-5 d-flex no-block align-items-center">
              <div>
                <span class="fs-18 mb-3">Top Facility</span>
                <h2 class="mb-2 mt-2">
                  {{
                    carouselItems().length > 0
                      ? carouselItems()[0].utilization
                      : 0
                  }}%
                </h2>
                <span class="m-0 fs-15 mt-4 text-muted">Utilization Rate</span>
              </div>
            </div>
            <div class="col-sm-7 my-auto">
              <div id="bitcoin">
                <spk-apex-charts
                  [chartOptions]="capacityLineChart"
                ></spk-apex-charts>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-sm-12 col-md-6 col-lg-6 col-xl-6">
        <div class="card custom-card">
          <div class="card-body">
            <span class="fs-18">Status Breakdown</span>
            <div class="row mt-3">
              <div
                class="col-sm-6 my-auto border-end text-centerd-flex no-block align-items-center"
              >
                <div class="d-flex">
                  <div id="yourprofile">
                    <spk-apex-charts
                      [chartOptions]="operationalStatusChart"
                    ></spk-apex-charts>
                  </div>
                  <div class="my-auto d-block ms-3">
                    <h6 class="mb-2 fs-16">
                      {{
                        dashboardStats()
                          ? (
                              (dashboardStats()!.statusDistribution
                                .fullyOperational /
                                totalFacilities()) *
                              100
                            ).toFixed(0)
                          : 0
                      }}%
                    </h6>
                    <span class="m-0 fs-14 text-muted">Operational</span>
                  </div>
                </div>
              </div>
              <div class="col-sm-6 my-auto text-sm-center">
                <h2 class="mb-2 mt-3 mt-sm-0">
                  {{
                    dashboardStats()
                      ? (
                          (dashboardStats()!.statusDistribution
                            .underMaintenance /
                            totalFacilities()) *
                          100
                        ).toFixed(0)
                      : 0
                  }}%
                </h2>
                <span class="m-0 fs-14 mt-3 text-muted">In Maintenance</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card custom-card">
      <div class="card-header border-bottom-0">
        <div
          class="d-flex justify-content-between align-items-center flex-wrap"
        >
          <div>
            <div class="card-title">FACILITY OPERATIONS LOG</div>
            <span class="d-block fs-12 mb-0 text-muted"
              >Facility operations log tracks maintenance activities, status
              changes, and operational milestones for all facilities</span
            >
          </div>
          <div class="d-flex gap-2 mt-2 mt-md-0">
            <button
              class="btn btn-sm btn-primary"
              (click)="exportToExcel()"
              title="Export to Excel"
            >
              <i class="fe fe-download me-1"></i>Export
            </button>
            <button
              class="btn btn-sm btn-success"
              (click)="initializeNewFacility()"
              title="Initialize New Facility"
            >
              <i class="fe fe-plus me-1"></i>Add Facility
            </button>
          </div>
        </div>
      </div>
      <div class="card-body pt-3">
        <!-- Filter Bar -->
        <div class="row mb-3 g-2">
          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label fs-12 mb-1">Facility</label>
            <spk-ng-select
              [options]="facilityFilterOptions()"
              [defaultValue]="selectedFacility() || null"
              [placeholder]="'All Facilities'"
              [clearable]="true"
              [searchable]="true"
              (selectedChange)="onFacilityFilterChange($event)"
            ></spk-ng-select>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label fs-12 mb-1">Location</label>
            <spk-ng-select
              [options]="locationFilterOptions()"
              [defaultValue]="
                selectedLocations().length > 0 ? selectedLocations() : []
              "
              [placeholder]="'All Locations'"
              [clearable]="true"
              [multiple]="true"
              [searchable]="true"
              (selectedChange)="onLocationFilterChange($event)"
            ></spk-ng-select>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label fs-12 mb-1">Status</label>
            <spk-ng-select
              [options]="statusFilterOptions()"
              [defaultValue]="
                selectedStatuses().length > 0 ? selectedStatuses() : []
              "
              [placeholder]="'All Statuses'"
              [clearable]="true"
              [multiple]="true"
              [searchable]="true"
              (selectedChange)="onStatusFilterChange($event)"
            ></spk-ng-select>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label fs-12 mb-1">Efficiency</label>
            <spk-ng-select
              [options]="efficiencyFilterOptions"
              [defaultValue]="selectedEfficiencyRange() || null"
              [placeholder]="'All Efficiency'"
              [clearable]="true"
              (selectedChange)="onEfficiencyFilterChange($event)"
            ></spk-ng-select>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <label class="form-label fs-12 mb-1">Repair Queue</label>
            <spk-ng-select
              [options]="repairQueueFilterOptions"
              [defaultValue]="selectedRepairQueue() || null"
              [placeholder]="'All Repair Queues'"
              [clearable]="true"
              (selectedChange)="onRepairQueueFilterChange($event)"
            ></spk-ng-select>
          </div>
          <div class="col-12 col-md-6 col-lg-4">
            <label class="form-label fs-12 mb-1">Search</label>
            <div class="input-group">
              <span class="input-group-text">
                <i class="fe fe-search"></i>
              </span>
              <input
                type="text"
                class="form-control"
                placeholder="SEARCH FACILITY, LOCATION, OR ID..."
                [value]="searchTerm()"
                (input)="onSearchChange($event)"
              />
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-2 d-flex align-items-end">
            @if (activeFilterCount() > 0) {
            <button
              class="btn btn-sm btn-outline-secondary w-100"
              (click)="clearAllFilters()"
            >
              Clear Filters ({{ activeFilterCount() }})
            </button>
            }
          </div>
        </div>

        <!-- Results Summary -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="fs-13 text-muted">
            @if (sortedFacilityTableData().length > 0) { Showing
            {{ (currentPage() - 1) * pageSize() + 1 }}-{{
              Math.min(
                currentPage() * pageSize(),
                sortedFacilityTableData().length
              )
            }}
            of {{ sortedFacilityTableData().length }} facilities } @else { No
            facilities found. Total facilities loaded:
            {{ facilityTableData().length }}
            }
          </span>
        </div>

        <!-- Table -->
        <div class="table-responsive tasks">
          <table class="table card-table table-vcenter text-nowrap mb-0 border">
            <thead>
              <tr>
                @for (column of facilityTableColumns; track column.field) {
                <th
                  [class]="column.tableHeadColumn"
                  [class.cursor-pointer]="column.sortable"
                  (click)="column.sortable && sortTable(column.field)"
                >
                  <div class="d-flex align-items-center">
                    <span>{{ column.header }}</span>
                    @if (column.sortable && sortColumn() === column.field) {
                    <i
                      class="fe ms-1"
                      [class.fe-arrow-up]="sortDirection() === 'asc'"
                      [class.fe-arrow-down]="sortDirection() === 'desc'"
                    ></i>
                    } @else if (column.sortable) {
                    <i
                      class="fe fe-arrow-up-down ms-1 text-muted opacity-50"
                    ></i>
                    }
                  </div>
                </th>
                }
              </tr>
            </thead>
            <tbody>
              @for (facility of paginatedFacilityTableData(); track facility.id;
              let i = $index) {
              <tr>
                <td>{{ (currentPage() - 1) * pageSize() + i + 1 }}</td>
                <td class="coin_icon mt-2">
                  <div class="d-flex align-items-center">
                    <div class="cryp-icon bg-primary me-2">
                      <i class="fe fe-building"></i>
                    </div>
                    <div class="d-flex flex-column">
                      <a
                        [routerLink]="[
                          '/dashboard',
                          'facility-operations',
                          facility.facilityId
                        ]"
                        class="text-decoration-none facility-link"
                      >
                        <span class="my-auto"
                          >{{ facility.name }} <b>{{ facility.type }}</b></span
                        >
                      </a>
                      @if (facility.hasAlerts) {
                      <span class="badge bg-danger badge-sm mt-1">
                        {{ facility.alertCount }} Alert{{
                          facility.alertCount > 1 ? "s" : ""
                        }}
                      </span>
                      }
                    </div>
                  </div>
                </td>
                <td>{{ facility.location }}</td>
                <td>
                  <span [ngClass]="facility.efficiencyClass">{{
                    facility.efficiencyDisplay
                  }}</span>
                </td>
                <td>{{ facility.utilizationDisplay }}</td>
                <td>{{ facility.totalUnits }}</td>
                <td>{{ facility.activeUnits }}</td>
                <td>{{ facility.maintenanceUnits }}</td>
                <td>
                  <div class="d-flex align-items-center">
                    <span>{{ facility.repairUnits }}</span>
                    @if (facility.repairQueueStatus === 'critical') {
                    <span class="badge bg-danger badge-sm ms-2">CRITICAL</span>
                    } @else if (facility.repairQueueStatus === 'warning') {
                    <span class="badge bg-warning badge-sm ms-2">WARNING</span>
                    }
                  </div>
                </td>
                <td>
                  <span [ngClass]="facility.changeClass">{{
                    facility.change
                  }}</span>
                </td>
                <td>
                  <span [id]="facility.chartId">
                    <spk-apex-charts
                      [chartOptions]="sparklineChart"
                    ></spk-apex-charts>
                  </span>
                </td>
                <td class="text-start">
                  <a
                    href="javascript:void(0);"
                    [ngClass]="facility.statusClass"
                    >{{ facility.status }}</a
                  >
                </td>
              </tr>
              } @empty {
              <tr>
                <td
                  [attr.colspan]="facilityTableColumns.length"
                  class="text-center py-4"
                >
                  <p class="text-muted mb-0">
                    No facilities match your filters.
                  </p>
                  <button
                    class="btn btn-sm btn-outline-primary mt-2"
                    (click)="clearAllFilters()"
                  >
                    Clear All Filters
                  </button>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        @if (totalPages() > 1) {
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div>
            <span class="fs-13 text-muted"
              >Page {{ currentPage() }} of {{ totalPages() }}</span
            >
          </div>
          <div class="btn-group" role="group">
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              [disabled]="currentPage() === 1"
              (click)="goToPage(currentPage() - 1)"
            >
              <i class="fe fe-chevron-left"></i> Previous
            </button>
            @if (totalPages() <= 7) { @for (page of
            [].constructor(totalPages()); track $index) {
            <button
              type="button"
              class="btn btn-sm"
              [class.btn-primary]="currentPage() === $index + 1"
              [class.btn-outline-primary]="currentPage() !== $index + 1"
              (click)="goToPage($index + 1)"
            >
              {{ $index + 1 }}
            </button>
            } } @else { @if (currentPage() <= 3) { @for (page of
            [].constructor(5); track $index) {
            <button
              type="button"
              class="btn btn-sm"
              [class.btn-primary]="currentPage() === $index + 1"
              [class.btn-outline-primary]="currentPage() !== $index + 1"
              (click)="goToPage($index + 1)"
            >
              {{ $index + 1 }}
            </button>
            }
            <span class="btn btn-sm btn-outline-primary disabled">...</span>
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              (click)="goToPage(totalPages())"
            >
              {{ totalPages() }}
            </button>
            } @else if (currentPage() >= totalPages() - 2) {
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              (click)="goToPage(1)"
            >
              1
            </button>
            <span class="btn btn-sm btn-outline-primary disabled">...</span>
            @for (page of [].constructor(5); track $index) {
            <button
              type="button"
              class="btn btn-sm"
              [class.btn-primary]="currentPage() === totalPages() - 4 + $index"
              [class.btn-outline-primary]="
                currentPage() !== totalPages() - 4 + $index
              "
              (click)="goToPage(totalPages() - 4 + $index)"
            >
              {{ totalPages() - 4 + $index }}
            </button>
            } } @else {
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              (click)="goToPage(1)"
            >
              1
            </button>
            <span class="btn btn-sm btn-outline-primary disabled">...</span>
            @for (page of [].constructor(3); track $index) {
            <button
              type="button"
              class="btn btn-sm"
              [class.btn-primary]="currentPage() === currentPage() - 1 + $index"
              [class.btn-outline-primary]="
                currentPage() !== currentPage() - 1 + $index
              "
              (click)="goToPage(currentPage() - 1 + $index)"
            >
              {{ currentPage() - 1 + $index }}
            </button>
            }
            <span class="btn btn-sm btn-outline-primary disabled">...</span>
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              (click)="goToPage(totalPages())"
            >
              {{ totalPages() }}
            </button>
            } }
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              [disabled]="currentPage() === totalPages()"
              (click)="goToPage(currentPage() + 1)"
            >
              Next <i class="fe fe-chevron-right"></i>
            </button>
          </div>
        </div>
        }
      </div>
    </div>
  </div>
  <div class="col-md-12 col-sm-12 col-lg-12 col-xl-12 col-xxl-4">
    <div class="card custom-card overflow-hidden">
      <div class="card-header border-bottom-0">
        <div>
          <div class="card-title">Activity</div>
          <span class="d-block fs-12 mb-0 mt-1 text-muted"
            >Facility activity timeline showing maintenance events, status
            changes, and operational updates</span
          >
        </div>
      </div>
      <ul class="crypto-transcation list-unstyled mg-b-0 mt-3">
        @for (activity of activities(); track activity.id) {
        <li class="list-item px-3 pb-3 {{ $last ? 'mb-0' : '' }}">
          <div class="media align-items-center">
            <div class="crypto-icon bg-primary-transparent text-primary">
              <i
                [class]="
                  (activity.icon || 'fe fe-activity') +
                  ' wd-20 ht-20 text-center fs-18'
                "
              ></i>
            </div>
            <div class="media-body ms-3">
              <p class="fw-medium mg-b-3 fs-15">{{ activity.title }}</p>
              <p class="fs-11 mg-b-0 text-gray-3">{{ activity.description }}</p>
            </div>
          </div>
          <div class="text-end ms-auto my-auto">
            <h5 class="fw-medium fs-16 mb-0">
              <span
                [ngClass]="
                  activity.impactLevel === 'Critical'
                    ? 'text-danger'
                    : activity.impactLevel === 'High'
                    ? 'text-warning'
                    : 'text-success'
                "
              >
                {{ activity.impactLevel }}
              </span>
            </h5>
          </div>
        </li>
        }
      </ul>
    </div>
  </div>
</div>
<!-- row closed -->
