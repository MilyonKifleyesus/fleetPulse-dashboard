<div class="facility-strips">
  <ng-container *ngFor="let f of facilitiesToShow; trackBy: trackByFacilityId">
    <div class="strip-card">
      <div class="strip-header">
        <div class="strip-title">
          {{ f.name }}
          <span *ngIf="isAllView" class="strip-tag">Facility</span>
        </div>
        <div class="strip-sub">
          Vehicles assigned: {{ vehiclesAssigned(f.id) }} ·
          EV share: {{ percentElectric(f.id) }}%
        </div>
      </div>

      <ng-container *ngIf="getInfo(f.id) as info">
        <!-- editable info rows -->
        <div class="strip-grid">
          <div class="strip-grid-left">
            <!-- Address & coordinates -->
            <div class="strip-row">
              <div class="label">Address &amp; Coordinates</div>

              <div class="value" *ngIf="!isEditing(f.id, 'address')">
                {{ info.address || 'Not set' }}
                <span *ngIf="info.coordinates">
                  · {{ info.coordinates }}
                </span>
              </div>

              <div class="value value--edit" *ngIf="isEditing(f.id, 'address')">
                <input
                  type="text"
                  placeholder="Facility address"
                  [(ngModel)]="info.address"
                />
                <input
                  type="text"
                  placeholder="Coordinates (lat, lng)"
                  [(ngModel)]="info.coordinates"
                />
              </div>

              <button
                type="button"
                class="mini-btn"
                (click)="toggleEdit(f.id, 'address')"
              >
                {{ isEditing(f.id, 'address') ? 'Save' : 'Edit' }}
              </button>
            </div>

            <!-- Mechanics -->
            <div class="strip-row">
              <div class="label">Mechanics</div>

              <div class="value" *ngIf="!isEditing(f.id, 'mechanics')">
                {{ info.mechanics ?? 'Not set' }}
              </div>

              <div class="value value--edit" *ngIf="isEditing(f.id, 'mechanics')">
                <input type="number" min="0" [(ngModel)]="info.mechanics" />
              </div>

              <button
                type="button"
                class="mini-btn"
                (click)="toggleEdit(f.id, 'mechanics')"
              >
                {{ isEditing(f.id, 'mechanics') ? 'Save' : 'Edit' }}
              </button>
            </div>

            <!-- Apprentices -->
            <div class="strip-row">
              <div class="label">Apprentices</div>

              <div class="value" *ngIf="!isEditing(f.id, 'apprentices')">
                {{ info.apprentices ?? 'Not set' }}
              </div>

              <div class="value value--edit" *ngIf="isEditing(f.id, 'apprentices')">
                <input type="number" min="0" [(ngModel)]="info.apprentices" />
              </div>

              <button
                type="button"
                class="mini-btn"
                (click)="toggleEdit(f.id, 'apprentices')"
              >
                {{ isEditing(f.id, 'apprentices') ? 'Save' : 'Edit' }}
              </button>
            </div>

            <!-- Support staff -->
            <div class="strip-row">
              <div class="label">Support Staff</div>

              <div class="value" *ngIf="!isEditing(f.id, 'supportStaff')">
                {{ info.supportStaff ?? 'Not set' }}
              </div>

              <div class="value value--edit" *ngIf="isEditing(f.id, 'supportStaff')">
                <input type="number" min="0" [(ngModel)]="info.supportStaff" />
              </div>

              <button
                type="button"
                class="mini-btn"
                (click)="toggleEdit(f.id, 'supportStaff')"
              >
                {{ isEditing(f.id, 'supportStaff') ? 'Save' : 'Edit' }}
              </button>
            </div>

            <!-- Maintenance bays -->
            <div class="strip-row">
              <div class="label">Maintenance Bays</div>

              <div class="value" *ngIf="!isEditing(f.id, 'maintenanceBays')">
                {{ info.maintenanceBays ?? 'Not set' }}
              </div>

              <div class="value value--edit" *ngIf="isEditing(f.id, 'maintenanceBays')">
                <input type="number" min="0" [(ngModel)]="info.maintenanceBays" />
              </div>

              <button
                type="button"
                class="mini-btn"
                (click)="toggleEdit(f.id, 'maintenanceBays')"
              >
                {{ isEditing(f.id, 'maintenanceBays') ? 'Save' : 'Edit' }}
              </button>
            </div>

            <!-- Facility score + last audit -->
            <div class="strip-row">
              <div class="label">Facility Score &amp; Last Audit</div>

              <div class="value" *ngIf="!isEditing(f.id, 'facilityScore')">
                <span>Score: {{ info.facilityScore ?? 'Not set' }}</span>
                <span class="dot-sep"></span>
                <span>Audit: {{ info.lastAuditDate ?? 'Not set' }}</span>
              </div>

              <div
                class="value value--edit"
                *ngIf="isEditing(f.id, 'facilityScore')"
              >
                <input
                  type="number"
                  min="0"
                  max="100"
                  placeholder="Score (0–100)"
                  [(ngModel)]="info.facilityScore"
                />
                <input type="date" [(ngModel)]="info.lastAuditDate" />
              </div>

              <button
                type="button"
                class="mini-btn"
                (click)="toggleEdit(f.id, 'facilityScore')"
              >
                {{ isEditing(f.id, 'facilityScore') ? 'Save' : 'Edit' }}
              </button>
            </div>
          </div>

          <div class="strip-grid-right">
            <div class="strip-row strip-row--garage">
              <div class="label">Garage Picture</div>

              <div class="value" *ngIf="!isEditing(f.id, 'garageImageUrl')">
                <img
                  *ngIf="info.garageImageUrl"
                  [src]="info.garageImageUrl"
                  alt="{{ f.name }} garage"
                  class="garage-thumb"
                />
                <span *ngIf="!info.garageImageUrl">Not set</span>
              </div>

              <div
                class="value value--edit"
                *ngIf="isEditing(f.id, 'garageImageUrl')"
              >
                <input
                  type="text"
                  placeholder="Image URL"
                  [(ngModel)]="info.garageImageUrl"
                />
              </div>

              <button
                type="button"
                class="mini-btn"
                (click)="toggleEdit(f.id, 'garageImageUrl')"
              >
                {{ isEditing(f.id, 'garageImageUrl') ? 'Save' : 'Edit' }}
              </button>
            </div>
          </div>
        </div>

        <!-- non-editable: charts/metrics -->
        <div class="metrics-row">
          <!-- Bus models doughnut -->
          <div class="metric-card">
            <div class="metric-label">Bus Models</div>

            <div class="metric-chart">
              <spk-chartjs2
                [data]="busModelChartData(f.id)"
                [options]="doughnutOptions"
                [type]="doughnutType"
              ></spk-chartjs2>
            </div>

            <!-- Text legend under chart -->

            <div class="legend">
              <span *ngFor="let m of dummyModelBreakdown(f.id)">
                {{ m.label }} ({{ m.pct }}%)
              </span>
            </div>

          </div>
          

          <!-- Status of buses doughnut -->
          <div class="metric-card">
            <div class="metric-label">Status of Buses</div>

            <div class="metric-chart">
              <spk-chartjs2
                [data]="statusChartData(f.id)"
                [options]="doughnutOptions"
                [type]="doughnutType"
              ></spk-chartjs2>
            </div>

            <!-- Text legend under chart -->

            <div class="legend">
              <span
                *ngFor="let s of statusBreakdown(f.id); trackBy: trackByStatusLabel"
              >
                {{ s.label }} ({{ s.pct }}%)
              </span>
            </div>

          </div>
        </div>

      </ng-container>
    </div>
  </ng-container>
</div>
