<app-page-header [title]="'Welcome To FleetPulse Dashboard'" [title1]="['Home']"
  [activeitem]="'Fleet Management Dashboard'"></app-page-header>

<!-- Loading State -->
@if (isLoading) {
<div class="row row-sm">
  <div class="col-12">
    <div class="card custom-card">
      <div class="card-body text-center p-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading dashboard data...</p>
      </div>
    </div>
  </div>
</div>
}

<!-- Error State -->
@if (errorMessage && !isLoading) {
<div class="row row-sm">
  <div class="col-12">
    <div class="alert alert-danger" role="alert">
      <h4 class="alert-heading">Error Loading Data</h4>
      <p>{{ errorMessage }}</p>
      <hr />
      <button class="btn btn-primary" (click)="loadData()">Retry</button>
    </div>
  </div>
</div>
}

<!-- Empty State -->
@if (!hasData && !isLoading && !errorMessage) {
<div class="row row-sm">
  <div class="col-12">
    <div class="card custom-card">
      <div class="card-body text-center p-5">
        <i class="fe fe-alert-circle fs-48 text-muted mb-3"></i>
        <h4>No Fleet Data Available</h4>
        <p class="text-muted">
          Please import an Excel file to begin viewing your fleet data.
        </p>
      </div>
    </div>
  </div>
</div>
}

<!-- Main Dashboard Content -->
@if (hasData && !isLoading && !errorMessage) {
<div class="workspace-dashboard-container">
  <!-- Edit Mode Toggle -->
  <div class="workspace-controls mb-3">
    <button class="btn btn-sm btn-outline-primary" (click)="toggleEditMode()" type="button">
      <i class="fe" [class.fe-edit]="modeServiceInstance.isViewMode()"
        [class.fe-eye]="modeServiceInstance.isEditMode()"></i>
      {{ modeServiceInstance.isEditMode() ? 'View Mode' : 'Edit Mode' }}
    </button>
  </div>

  <!-- Workspace Grid -->
  <app-workspace [workspaceId]="workspaceId" [widgets]="widgets">
    <!-- Metric Card Widgets - Use data-widget-id for proper matching -->
    @for (card of cards; track $index) {
    <div [attr.data-widget-id]="'widget-metric-' + ($index + 1)" style="display: contents;">
      <spk-dashboard [card]="card"></spk-dashboard>
    </div>
    }

    <!-- Chart Widget -->
    <div data-widget-id="widget-chart-1" style="display: contents;">
      <div class="card custom-card overflow-hidden">
        <div class="card-header border-bottom-0 d-flex justify-content-between align-items-center">
          <div>
            <label class="main-content-label mb-2">Fleet Utilization</label>
            <span class="d-block fs-12 mb-0 text-muted">
              Track active vehicles and vehicles in service over time to monitor fleet deployment efficiency
            </span>
          </div>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-primary" [class.active]="selectedPeriod === '30d'"
              (click)="onPeriodChange('30d')">
              Last 30 Days
            </button>
            <button type="button" class="btn btn-outline-primary" [class.active]="selectedPeriod === 'quarter'"
              (click)="onPeriodChange('quarter')">
              Last Quarter
            </button>
            <button type="button" class="btn btn-outline-primary" [class.active]="selectedPeriod === 'year'"
              (click)="onPeriodChange('year')">
              Last Year
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="project">
            <spk-apex-charts [chartOptions]="ChartOptions"></spk-apex-charts>
          </div>
        </div>
      </div>
    </div>

    <!-- Activity Feed Widget -->
    <div data-widget-id="widget-activity" style="display: contents;">
      <div class="card custom-card card-dashboard-calendar">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <label class="main-content-label mb-2 pt-1">Recent System Activities</label>
            <span class="d-block fs-12 mb-2 text-muted">
              Latest system activities including vehicle status changes, new vehicles, imports, and health score alerts
            </span>
          </div>
        </div>
        @if (lastSync) {
        <p class="fs-11 text-muted mb-2">Last sync: {{ formatDate(lastSync) }}</p>
        }
        <spk-reusable-tables [tableClass]="'table m-b-0 transcations mt-2'" [showCheckbox]="false">
          @for (activity of transactions; track activity.id) {
          <tr>
            <td class="wd-5p">
              <div class="main-img-user avatar-md">
                <img alt="activity" class="rounded-circle me-3"
                  [src]="activity.icon || './assets/images/faces/4.jpg'" />
              </div>
            </td>
            <td>
              <div class="d-flex align-middle ms-3">
                <div class="d-inline-block">
                  <h6 class="mb-1">{{ activity.title }}</h6>
                  <p class="mb-0 fs-13 text-muted">
                    {{ activity.description }}
                  </p>
                </div>
              </div>
            </td>
            <td class="text-end">
              <div class="d-inline-block">
                <p class="mb-0 tx-11 text-muted">
                  {{ formatDate(activity.timestamp) }}
                </p>
              </div>
            </td>
          </tr>
          }
          @if (transactions.length === 0) {
          <tr>
            <td colspan="3" class="text-center text-muted p-4">
              No recent activities
            </td>
          </tr>
          }
        </spk-reusable-tables>
      </div>
    </div>

    <!-- Table Widget -->
    <div data-widget-id="widget-table" style="display: contents;">
      <div class="card custom-card mg-b-20 tasks">
        <div class="card-body">
          <div class="card-header border-bottom-0 pt-0 ps-0 pe-0 pb-2 d-flex">
            <div>
              <div class="card-title">Vehicles Requiring Maintenance</div>
              <p class="mb-0 fs-12 mb-3 text-muted">
                Vehicles currently in maintenance queue or requiring urgent attention with priority and status tracking.
              </p>
            </div>
          </div>
          <div class="table-responsive tasks">
            <spk-reusable-tables [columns]="taskColumns"
              [tableClass]="'table card-table table-vcenter text-nowrap mb-0 border'" [showCheckbox]="false">
              @for (task of tasks; track $index) {
              <tr>
                <td class="fw-medium">{{ task.vehicleId }}</td>
                <td class="text-center">{{ task.location }}</td>
                <td class="text-center">{{ task.workOrderCount }}</td>
                <td class="text-center">{{ task.daysBetweenWorkOrders }}</td>
                <td [class]="task.priorityClass">{{ task.priority }}</td>
                <td>
                  <span class="badge bg-pill rounded-pill" [class]="task.statusClass">{{ task.status }}</span>
                </td>
              </tr>
              }
            </spk-reusable-tables>
          </div>
        </div>
      </div>
    </div>
  </app-workspace>
</div>
}